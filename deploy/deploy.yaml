kind: ServiceAccount
apiVersion: v1
metadata:
  name: application-operator
  namespace: applications
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: applications
  name: application-operator
rules:
- apiGroups: 
    - batch
  resources:
    - jobs
  verbs:
    - get
    - watch
    - list
    - create
    - update
    - delete
- apiGroups: 
    - application-controller.github.io
  resources: 
    - applications
  verbs:
    - get
    - watch
    - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: application-operator
  namespace: applications
subjects:
- kind: ServiceAccount
  name: application-operator
roleRef:
  kind: Role
  name: application-operator
  apiGroup: rbac.authorization.k8s.io
---
kind: Secret
apiVersion: v1
metadata:
  name: ansible-runner-vault
  namespace: applications
data:
  password: aGVsbG8=
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-runner-env-dir
  namespace: applications
data:
  cmdline: --vault-password-file /vault/password
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: config
  namespace: applications
data:
  default-template.yml: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: {{ .JobName }}
      namespace: {{ .Application.Namespace }}
    spec:
      backoffLimit: 0
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          name: {{ .JobName }}
          namespace: {{ .Application.Namespace }}
        spec:
          dns_policy: ClusterFirst
          dns_config:
            options:
              - name: ndots
                value: "1"
          serviceAccount: {{ index .Env "SERVICE_ACCOUNT" }}
          securityContext:
            runAsUser: 1030
            runAsGroup: 1030
            fsGroup: 1030
          containers:
            - name: configurator
              image: {{ index .Env "ANSIBLE_IMAGE" }}
              command:
                - {{ index .Env "ANSIBLE_COMMAND" }}
                - {{ .Application.Name }}
                - {{ .Application.Spec.Application }}
                - {{ .Application.Spec.Environment }}
                - {{ .Application.Spec.Version }}
              env:
                - name: POD_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name
              resources:
                limit:
                  cpu: 200m
                  memory: 128Mi
              volumeMounts:
                - name: ansible-runner-vault
                  mountPath: /vault
                - name: ansible-runner-env-dir
                  mountPath: /tmp/env
          volumes:
            - name: ansible-runner-vault
              secretRef:
                secretName: ansible-runner-vault
            - name: ansible-runner-env-dir
              configMapRef:
                name: ansible-runner-env-dir
          restartPolicy: Never
          backoffLimit: 0
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: env
  namespace: applications
data:
  ANSIBLE_IMAGE: applicationoperator/ansible-demo:v0.0.0
  ANSIBLE_COMMAND: /ansible/deploy.py
  SERVICE_ACCOUNT: application-operator
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: application-operator
  namespace: applications
  labels:
    app: application-operator
spec:
  selector:
    matchLabels:
      app: application-operator
  template:
    metadata:
      labels:
        app: application-operator
    spec:
      serviceAccount: application-operator
      securityContext:
        runAsUser: 1234
        runAsGroup: 1234
      containers:
        - name: application-operator
          command:
          - application-operator
          imagePullPolicy: Always
          env:
            - name: WATCH_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: TEMPLATE_DIR
              value: /config
            - name: OPERATOR_NAME
              value: "application-operator"
            - name: CONFIG_VERSION
              value: "abcd-1234"  # this should be configured by CI
          envFrom:
            - configMapRef:
                name: env
          image: willthames/application-operator:v0.0.1
          volumeMounts:
            - name: config
              mountPath: /config
      volumes:
        - name: config
          configMap:
            name: config
